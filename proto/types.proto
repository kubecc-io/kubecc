syntax = "proto3";
import "google/protobuf/wrappers.proto";
option go_package = "pkg/types";

message Empty {}

service Consumerd {
  rpc Run(RunRequest) returns (RunResponse);
}

service Agent {
  rpc Compile(CompileRequest) returns (CompileResponse);
}

service Scheduler {
  rpc AtCapacity(Empty) returns (google.protobuf.BoolValue);
  rpc Compile(CompileRequest) returns (CompileResponse);
  rpc Connect(stream Metadata) returns (stream Empty);
  rpc SystemStatus(Empty) returns (SystemStatusResponse);
}

message SystemStatusResponse {
  repeated ComponentStatus StatusItems = 1;
}

message ComponentStatus {
  Component Component = 1;
  bool Alive = 2;
}

message Metadata {
  Component Component = 1;
  repeated Toolchain Toolchains = 2;
}

enum Component {
  Component_Unknown_ = 0;
	Agent_ = 1;
	Scheduler_ = 2;
	Controller_ = 3;
	Consumer_ = 4;
	Consumerd_ = 5;
	Make_ = 6;
  Test_ = 7;
  Dashboard_ = 8;
}

enum ToolchainKind {
  ToolchainKind_Unknown_ = 0;
  Gnu_ = 1;
  Clang_ = 2;
}

enum ToolchainLang {
  ToolchainLang_Unknown_ = 0;
  C_ = 1;
  CXX_ = 2;
  Multi_ = 3;
}

message Toolchain {
  ToolchainKind Kind = 1;
  ToolchainLang Lang = 2;
  string Executable = 3;
  string TargetArch = 4;
  string Version = 5;
  bool PicDefault = 6;
}

message AgentToolchainInfo {
  string Kind = 1;
  string Target = 2;
  repeated string Versions = 3; 
}

message AgentToolchainInfoList {
  repeated AgentToolchainInfo info = 1; 
}

// consumer -> consumerd
message RunRequest {
  string Compiler = 1;
  repeated string Args = 2;
  uint32 UID = 3;
  uint32 GID = 4;
  string WorkDir = 5;
  repeated string Env = 6;
  bytes Stdin = 7;
}
// consumerd -> consumer
message RunResponse {
  int32 ReturnCode = 1;
  bytes Stdout = 2;
  bytes Stderr = 3;
}

// consumerd -> scheduler
message ScheduleRequest {}

// scheduler -> consumerd
message ScheduleResponse {}


message AgentInfo {
  // System Info
  string Arch = 1;
  int32 NumCpus = 2;

  // Downward API
  string Node = 3;
  string Pod = 4;
  string Namespace = 5;
}

// consumerd -> scheduler -> agent
message CompileRequest {
  Toolchain Toolchain = 1;
  repeated string Args = 2;
  bytes PreprocessedSource = 3;
}

// agent -> scheduler -> consumerd
message CompileResponse {
  enum Result {
    Success = 0;
    Fail = 1;
  }
  Result CompileResult = 1;
  oneof Data {
    string Error = 3;
    bytes CompiledSource = 4;
  }
}
